# CHAPTER.02

## 리팩터링 원칙

리팩터링 전반에 적용되는 원칙 몇가지를 알아보자

### 리팩터링 정의

리팩터링은 `겉보기 동작`은 그대로 유지한 채 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법 또는 그러한 행위를 이야기한다.

앞장에서 살펴본 `함수 추출하기`가 그 예시이다.

리팩터링은 동작을 보존한 채 작은 단계들을 거쳐 코드를 수정하고, 이러한 단계뜰을 순차적으로 연결하여 큰 변화를 만들어내는 일이다.

리팩터링하는 동안에는 코드가 항상 정상 작동하기 때문에 전체 작업이 끝나지 않았더라도 언제든 멈출 수 있어야한다. → 리팩터링하다가 코드가 깨져서 고생했다 → 리팩터링한 것이 아니다.

겉보기 동작이 같다는 말이 무엇일까?

- 함수 추출하기 같은 행위를 하면 콜스택이 달라지는데.. 이런건 겉보기 동작이 아니다.
- 사용자 관점에서 달라지는 점이 없어야한다는게 중요한 점이다.
- 이런 관점에서 리팩터링은 성능 최적화와 유사하다. 둘 다 코드를 변경하지만 프로그램의 전반적인 기능은 그대로 유지한다. 단지 목적만 다를 뿐이다.

### 리팩터링하는 이유

리팩터링이 SW의 모든 문제점을 해결해주진 않지만, 코드를 건강한 상태로 유지하는데 도와주는 약임은 분명하다.

**[리팩터링하면 소프트웨어 설계가 좋아진다.]**

리팩터링하지 않으면 소프트웨어의 아키텍처가 무너지기 쉽다. 아키텍처를 충분히 이해하지 않은 채 단기 목표 만을 위해 코드를 추가하다보면 기반 구조가 무너진다. 그 이후는 코드만 봐서는 아키텍처를 알기 어려워진다.

코드만봐서 설계 파악이 어려워질수록 설계를 유지하기 어려워지고 설계가 무너지는 속도는 더욱 빨라진다.

반면 규칙적인 리팩토링은 코드의 구조를 지탱해준다.

같은 일을 하더라도 설계가 나쁘면 코드가 길어진다. 중복 코드의 증가가 그 예시이다.

코드가 짧다고 시스템이 빨라지는 것은 아니지만, 코드량이 줄면 유지보수해야하는데 드는 노력이 줄어든다. 또한 실수도 줄어든다.

**[리팩터링하면 소프트웨어를 이해하기 쉬워진다.]**

프로그래밍은 컴퓨터에게 내가 시키려는 일을 표현하는 것이다. 이 표현이 복잡하면 다른 사람이 코드를 보았을 때 유지보수하기가 너무 어려워진다. 나중에 그 코드를 볼 개발자(나 포함)를 배려하자.

**[리팩터링하면 버그를 쉽게 찾을 수 있다.]**

코드를 이해하기 쉽다는 말은 버그를 찾기 쉽다는 말이기도하다. 리팩터링을 하면 코드가 하는 일을 깊이 파악하게 된다. 이러면 버그를 이전보다 수월하게 찾을 수 있다.

프로그램의 구조를 명확하게 다듬으면 그냥 “이럴 것이다.”라고 가정했던 것들이 코드에 분명하게 드러나게 된다. → 버그가 명확하게 보인다.

**[리팩터링하면 프로그래밍 속도를 높일 수 있다.]**

리팩터링을 하면 시간이 드니 전체 개발 속도가 떨어질 것이라 생각할 수 있다.

리팩터링을 하지 않으면 초기에는 개발이 빠를 수 있지만 시간이 갈수록 생산성이 떨어진다.

모듈화가 잘 되어 있으면 새로운 기능을 어디에 추가할지, 어떻게 고칠지를 쉽게 찾을 수 있다. 또한 전체 코드 베이스 중 일부만 이해하면 된다.

## 언제 리팩터링을 해야할까?

**[3의 법칙]**

1. 처음에는 그냥한다.
2. 비슷한 일을 두번째로 하게되면(똑같은거 또하네? 당황하며) 일단 계속 진행한다.
3. 세번째로 하게 되면 리팩터링한다.

**[준비를 위한 리팩터링: 기능을 쉽게 추가하게 만들기]**

리팩터링을 하기 가장 좋은 시점은 코드베이스에 기능을 새로 추가하기 직전이다. 이 시점에 현재 코드를 살펴보면서, 구조를 살짝 바꾸면 다른 작업을 하기가 훨씬 쉬워질 만한 부분을 찾는다.

**[이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들기]**

코드를 수정하려면 먼저 그 코드가 하는 일을 파악해야한다. 코드를 파악할 때 마다 그 코드의 의도가 더 명확하게 드러나도록 리팩터링할 여지는 없는지 찾아본다. 이런 작업을 하다보면 전에는 보이지 않던 설계가 보이기도 하고, 내가 해야할 작업이 더 명확해지기도 한다.

**[계획된 리팩터링과 수시로하는 리팩터링]**

리팩터링은 기본적으로 수시로 하자. 개발하는 과정에서 if문을 추가하는 시간을 따로 내지 않듯 기능 추가와 리팩터링하는 시간을 굳이 나눌 필요가 없다. 조금씩 조금씩 코드를 개선해나가자.

보기 싫은 코드를 발견하면 리팩터링하자. 근데 잘 작성된 코드도 리팩터링이 필요하다. 어제에 적합했던 기준이 오늘에는 달라질 수 있기 때문이다.

소프트웨어 개발이란 뭔가를 `추가`하는 과정으로 여기는 것이 대부분이지만 뛰어난 개발자는 코드를 추가하기 쉽도록 `수정`하는 것이 중요하다는 것을 알고 있다.

계획된 리팩터링을 하는 것이 나쁜 것은 아니다. 다만 수시로 하는 리팩터링이 조금더 효과적인 것 같다.

**[오래 걸리는 리팩터링]**

리팩터링은 대부분 몇 분, 몇시간 정도면 끝난다. 하지만 팀 전체가 몇주동안 해야하는 리팩터링도 있다. 라이브러리 교체, 코드 컴포넌트 분리, 그동안 묵혀왔던 의존성 정리 등이 그 예시이다.

이런 상황에서도 팀 전체가 리팩터링에 매달리는 것은 회의적이다. 주어진 문제를 조금씩 해결해나가는 편이 효과적일 때가 많다.

리팩터링은 기존 코드를 깨트리지 않는다는 점을 활용하여 조금씩 해결해나가는 것이다.

**[관리자에게는 뭐라고 말해야할까?]**

관리자에게 리팩터링에 대해 어떻게 말해야 하는지는 참 어려운 일이다. 관리자와 고객은 코드베이스의 건강 상태가 생산성에 미치는 영향을 모르기 대문이다.

개발자는 프로여야한다. 프로 개발자는 효과적인 소프트웨어를 최대한 빠르게 만들어야한다. 리팩터링을 하면 소프트웨어를 빠르게 만드는데 아주 효과적이다.

구체적인 방식은 개발자가 판단해야한다. 주어진 임무는 새로운 기능을 빠르게 구현하는 것이고, 때에 따라 리팩터링을 하는 것이 가장 빠른 방법일 수 있다. 그래서 리팩터링을 한다.

**[리팩터링을 하지 말아야할 때]**

리팩터링을 하면 안되는 상황도 있다.

- 굳이 수정할 필요가 없다면 리팩터링 하지 않는다. 외부 API 다루듯 호출만 하는 코드라면 지저분해도 그냥 둔다. 내부 동작을 이해해야할 시점이 와야 그 때 리팩터링의 효과를 제대로 볼 수 있다.
- 리팩터링하는 것보다 새로 작성하는게 쉬울 때도 리팩터링 하지 않는다. 근데 이건 판단하기가 아주 어려운 일이다. 경험으로 체득해야한다.

### 리팩터링 시 고려할 문제

리팩터링을 하면서 딸려오는 문제점들도 있기 때문에 이런 문제가 언제 발생하고 어떻게 대처해야하는지를 반드시 알고 있어야한다.

**[새 기능 개발 속도 저하]**

앞서 말한 것처럼 리팩터링이 속도를 오히려 올려준다고는 했지만, 실전에서는 리팩터링을 제대로 적용하는데 시간이 걸린다는 점이 가장 큰 걸림돌이다.

리팩터링을 할 때는 항상 상황에 맞게 조율해야한다. 내가 직접 건드릴 일이 거의 없거나, 불편한 정도가 그리 심하지 않다고 판단되면 리팩터링하지 않아도 된다. 하지만 리팩터링을 해야 생산성이 올라간다고 생각하면 리팩터링을 한다.

리팩터링은 `멋진 개발자라면 해야한다` 같은 도덕적인 이유로 하는 것이 아니다. 리팩터링을 하는 이유는 어디까지는 경제적인 효과에 있다. 좋은 설계 곡선을 만들 수 있도록 잘 조절하는 것이 좋다.

**[테스팅]**

리팩터링의 두드러진 특성은 프로그램의 겉보기 동작이 똑같이 유지된다는 것이다. 절차를 지켜 제대로 리팩터링하면 동작이 깨지지 않아야한다.

하지만 실수를한다면? → 여기서 핵심은 오류를 빠르게 잡는것에 있다. 이렇게 하려면 테스트 코드가 필요하다. 또한 이를 빠르게 실행할 수 있어야 테스트를 수시로 하는데 부담이 없다.

달리 말하면 리팩터링을 하기 위해서는테스트 코드를 마련해야한다는 의미이다. 이를 통해 리팩터링 과정에서 버그가 생길 위험이 크다는 불안감을 줄일 수 있다.

테스트 외에도 다른 방식으로도 해결할 수 있다. 바로 자동 리팩터링 기능을 제공해주는 IDE를 사용하는 것이다. 이를 활용하면 따로 테스트없이 리팩터링을 해도 좋다.

**[레거시 코드]**

레거시 코드는 테스트를 갖추고 있지도 않을 것이고 테스트하기 좋은 구조도 아닐 것이라 까다로운 점이 많다.

이 때 IDE의 자동 리팩터링 기능을 적극 활용하자. 또한 테스트가 있더라도 복잡하게 얽힌 레거시 코드를 단번에 리팩터링하는 데는 낙관적이지 않다. 서로 관련된 부분끼리 나눠서 하나씩 공략하는 것이 좋다. 코드 한 부분을 읽을 때마다 조금씩 조금씩 개선해나가는 방식을 사용해보자.

## 리팩터링과 성능

소프트웨어를 이해하기 쉽게 만들기 위해 속도가 느려지는 방향으로 수정하는 경우가 많다. 직관적인 설계와 성능은 중요한 주제다.

리팩터링을 하면 성능이 느려질 수 있는 건 사실이다. 하지만 그와 동시에 성능을 튜닝하기는 더 쉬워진다. hard realtime 시스템을 제외한 소프트웨어는 빠르게 만들기 위해 먼저 튜닝하기 쉽게 만들고 원하는 속도가 나게끔 튜닝하는 것이 효과적인 방식이다.

성능에 대한 흥미로운 사실은, 대부분의 프로그램은 전체 코드 중 극히 일부에서 대부분의 시간을 소모한다는 것이다. 그래서 코드 전체를 고르게 최적화한다면 그 중 90%는 효과가 없기 때문에 시간낭비인 것이다.

즉, 성능 문제가 있어 최적화를 해야하는 시점이 온 게 아니라면 성능에 신경쓰지 않고 코드를 다루기 쉽게 만드는데 집중한다. 그러다 성능 최적화가 필요한 시점이 오면 프로파일링으로 문제가 되는 부분을 찾고 그 부분을 수정하면 된다.

리팩터링을 잘해두면 성능 최적화에 두가지로 도움이 된다.

1. 성능 튜닝에 쓸 시간을 벌 수 있다.
    - 리팩터링이 잘되어있다면 기능 추가가 빨리 끝나서 성능에 집중할 시간을 벌 수 있다.
2. 리팩터링이 잘되어있는 프로그램은 성능을 더 세밀하게 분석할 수 있다.
    - 프로파일러가 지적해주는 코드 범위가 더 좁아질 것이고 그래서 튜닝하기 더 쉬워진다.
    - 코드가 깔끔하면 개선안들이 더 잘 떠오른다.

→ 즉, 리팩터링은 성능 좋은 프로그램을 만드는데도 기여한다.